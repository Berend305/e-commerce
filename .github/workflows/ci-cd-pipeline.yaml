name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io

    - name: Build Docker Image
      run: |
        docker build -t my-ecommerce-app:latest ./web

    - name: Push Docker Image to Docker Hub
      run: |
        docker login -u "berend305" -p "Nadber101"
        docker tag my-ecommerce-app:latest berend305/my-ecommerce-app:latest
        docker push berend305/my-ecommerce-app:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/

    - name: Configure kubeconfig
      run: |
        mkdir -p $HOME/.kube
        echo "apiVersion: v1
        kind: Config
        clusters:
        - cluster:
            server: https://192.168.151.241:6443
            certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJlRENDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUzTXpJNE56WTRNVEF3SGhjTk1qUXhNVEk1TVRBME1ERXdXaGNOTXpReE1USTNNVEEwTURFdwpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUzTXpJNE56WTRNVEF3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFSd3JxWDNOODY1VlNiZlVEYzU0NzZRTmlKRC9DRkVUWTNmbkFtUUFZSWwKN04zL01xODFCd1VWNzQ1ZGYrN21VVkhxS1BCcWVDNlMvbjlDR1c0bm5ndlZvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVTF4WTFwTVZLcmd5WGNEZG43Y3haCjhGWVFoUWd3Q2dZSUtvWkl6ajBFQXdJRFNRQXdSZ0loQUphQllFWXpoeS9lOEJGdDdvRkZiNndVSTNyQ0JXMFgKMHlGU2ZxZUNmUXRQQWlFQWtFSGZuOG9XZFNQMGE0NGlYRVJqT2Q0SndjeWhCOC9FbEV2bXZKQmlnR3M9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
          name: k3s-cluster
        contexts:
        - context:
            cluster: k3s-cluster
            user: k3s-user
          name: k3s-context
        current-context: k3s-context
        users:
        - name: k3s-user
          user:
            client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJrVENDQVRlZ0F3SUJBZ0lJWmVNeTRpdklzbE13Q2dZSUtvWkl6ajBFQXdJd0l6RWhNQjhHQTFVRUF3d1kKYXpOekxXTnNhV1Z1ZEMxallVQXhOek15T0RjMk9ERXdNQjRYRFRJME1URXlPVEV3TkRBeE1Gb1hEVEkxTVRFeQpPVEV3TkRBeE1Gb3dNREVYTUJVR0ExVUVDaE1PYzNsemRHVnRPbTFoYzNSbGNuTXhGVEFUQmdOVkJBTVRESE41CmMzUmxiVHBoWkcxcGJqQlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJEbHh0UlFvT3kwUlNiL24KWEdLVkYyYWMzM2RsbVZwZXQvWUNWZDJJWXRBNTJodi9LTGxtUC9tOEd1dHBhZ0hKUEwyaDZTZUdlWDBDVlFaMwpRTlp3OFhTalNEQkdNQTRHQTFVZER3RUIvd1FFQXdJRm9EQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBakFmCkJnTlZIU01FR0RBV2dCUTVyeG1UREJSOU1Vd1JxZGhkblA5UTIyQk9LREFLQmdncWhrak9QUVFEQWdOSUFEQkYKQWlFQXloM1pFWG9pTTdOKzVrTlpJZzFEanZBeC9FMks4MlEreFZWb3IvOUpHWXdDSUFxc0xnL1NEY2hDMnZvWgpKakRGTGFGRU45OXdGN09NUVNOU2JmNWhyZE1XCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkakNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdFkyeHAKWlc1MExXTmhRREUzTXpJNE56WTRNVEF3SGhjTk1qUXhNVEk1TVRBME1ERXdXaGNOTXpReE1USTNNVEEwTURFdwpXakFqTVNFd0h3WURWUVFEREJock0zTXRZMnhwWlc1MExXTmhRREUzTXpJNE56WTRNVEF3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFSOU1ETlJ6dWNaeHB5eUZuN05xcEc4TnV4ZHFjTFBzRTRyMndZSjFsY3IKZEdpL2FNOHVVc2MyTnJXVUk3Y3k0L1VUZVc1NVowczNkbjh3N25Ib3lxalJvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVU9hOFprd3dVZlRGTUVhbllYWnovClVOdGdUaWd3Q2dZSUtvWkl6ajBFQXdJRFJ3QXdSQUlnU2RFU0xZN2lqYTE4eG9EV3lMNnBoYzRreEIzbGJRS3YKcUphbm1hclZ4ZFlDSUNLMHlpdWQzLytDeHg5ZnF4cnk2SUFnanZvQ0lVMWk5Rkc1NXJ1ck1Rb0EKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo
            client-key-data: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSUp0WGxmN1JBZ2hCYnNaSFlzNnZMOWFTVnU1QnJ1SXpETGFlVXhuMjl3MmdvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFT1hHMUZDZzdMUkZKditkY1lwVVhacHpmZDJXWldsNjM5Z0pWM1loaTBEbmFHLzhvdVdZLworYndhNjJscUFjazh2YUhwSjRaNWZRSlZCbmRBMW5EeGRBPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo" > $HOME/.kube/config

    - name: Deploy to k3s Cluster
      run: |
        kubectl apply -f ./k3s/deployment.yaml
        kubectl apply -f ./k3s/service.yaml
